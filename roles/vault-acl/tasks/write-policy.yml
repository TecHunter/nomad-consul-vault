
- name: "Check if policy exists"
  shell:
    cmd: "vault policy read {{ policy_name }}"
  register: res
  failed_when: 'Error reading policy named' in res.stderr or 'local node not active but active cluster node not found' in res.stderr

- name: "Create Policy  {{ policy_name }} policy"
  shell:
    cmd: "vault policy write {{ policy_name }} -"
    stdin: "{{ lookup('file', policy_name+ '.hcl') }}"
  when: res.rc != 0
